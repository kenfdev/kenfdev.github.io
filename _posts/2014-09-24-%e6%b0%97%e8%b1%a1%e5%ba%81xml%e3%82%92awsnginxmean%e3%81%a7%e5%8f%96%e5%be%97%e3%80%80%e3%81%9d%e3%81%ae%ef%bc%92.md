---
title: 気象庁XMLをAWS+Nginx+MEANで取得　その２
author: kenev
layout: post
permalink: /2014/09/24/%e6%b0%97%e8%b1%a1%e5%ba%81xml%e3%82%92awsnginxmean%e3%81%a7%e5%8f%96%e5%be%97%e3%80%80%e3%81%9d%e3%81%ae%ef%bc%92/
categories:
  - JavaScript
  - NodeJS
tags:
  - PubSubHubbub
---
前回はとりあえず気象庁XMLを受け取る為のMEANな環境構築に少し触れたぐらい（Google先生観てね、で終わった会）ですが、今回は実際気象庁XMLを受け取る為に必要なAPIについて書いてみます。一応筆者の環境で受信確認はできたのでとりあえずは動く成果物です（笑）

まず第一にPubSubHubbubプロトコルでHubに対してSubscriberが「私は購読する意思がありますよー」という意思表明をする為にHubからGETリクエストで飛んでくる「チャレンジコード」に対して適切なレスポンスを返す必要があります。これを逃してしまうとHubからは「この人は購読する意思がないんだな」と判定されて購読の登録失敗、あるいは継続破棄されます。実際にどんなGETリクエストパラメータが飛んでくるかと言うと以下のような感じです。

?hub.verify\_token=（気象庁に申請したverify\_token）&hub.challenge=VBDYB\_（長いので略）xyST4D7x&hub.topic=（購読対象トピックのURL）&hub.mode=subscribe&hub.lease\_seconds=432000&#8242;

このリクエストのパラメータをパースしてhub.challengeの中身をそのままレスポンスで返せばチャレンジコードの応答成功となります。極端な話hub.challengeだけ注目すればレスポンスするだけなので購読の意思表示ができるのですが、本当に意図したチャレンジコードだったのか確かめる手段としてverify\_tokenをがあります。気象庁XMLの場合はHUBへの登録は気象庁が行う為、ユーザー登録時にverify\_tokenを指定することができます。hubからはこのverify_tokenがGETパラメータの中に入ってくる為、この値が自分が申請したものと一致するかどうかを確かめておくほうがセキュリティ的にはBETTERです。実際のNodejS+Expressのコードは以下の通り。

<pre class="lang:js decode:true ">app.get(callbackUrl, function(req, res) {
    var params = url.parse(req.url, true).query;
    var hubchallenge = params["hub.challenge"];
    var hubverify = params["hub.verify_token"];

    if (hubverify != MY_VERIFY_TOKEN) {
      // 何かしらのエラー処理
    }

    if ((hubmode == "subscribe" || hubmode == "unsubscribe")) {

        res.setHeader("Content-Length", hubchallenge.length);
        res.setHeader("Connection", 'closed');
        res.writeHead(200, {"Content-Type": 'text/plain'});
        res.end(hubchallenge);
    }
    else {
      // 何かしらのエラー処理
    }
});
</pre>

とりあえず上記のようなコードがあればHubへの購読意思表明は成功します。

次回はPublisher -> Hub -> Subscriberと渡ってくるfeedについて書きます。